# Веб-сервис для параллельного вычисления арифметических выражений

*ЕСЛИ ВОЗНИКЛИ ПРОБЛЕМЫ С МОИМ ПРОЕКТОМ, ВЫ МОЖЕТЕ СВЯЗАТЬСЯ СО МНОЙ В TELEGRAM: @unbiunii*

## Описание
Проект `calc_golang` — это веб-сервис, который вычисляет арифметические выражения с положительными числами, скобками и операциями `+`, `-`, `*`, `/`. Выражения обрабатываются асинхронно с использованием системы задач, что позволяет параллельно вычислять части сложных выражений. Сервис предоставляет REST API для отправки выражений, получения их статуса и результатов, а также просмотра всех сохраненных выражений.

Сервис разделен на две части:

- Сервер, который принимает арифметическое выражение, переводит его в набор последовательных задач и обеспечивает порядок их выполнения. Далее будем называть его оркестратором.
- Вычислитель, который может получить от оркестратора задачу, выполнить его и вернуть серверу результат. Далее будем называть его агентом.

Основные возможности сервиса:
- Отправка выражения на вычисление через POST-запрос к `/api/v1/calculate`.
- Получение статуса и результата конкретного выражения по его ID через GET-запрос к `/api/v1/expressions/{id}`.
- Получение списка всех выражений через GET-запрос к `/api/v1/expressions`.

Сервис возвращает ответы в формате JSON. 


Ответы сопровождаются следующими кодами:

| Код ответа | Описание |
| --- | --- |
| `200` | Выражение успешно получено / список выражений получен успешно |
| `201` | Выражение принято для вычисления |
| `422` | Невалидные данные |
| `404` | Выражение не найдено |
| `400` | Неверный формат запроса |
| `405` | Неверный метод запроса |
| `500` | Что-то пошло не так |

Схема работы сервиса представлена на изображении ниже:

![Image alt](https://github.com/zalhui/calc_golang/blob/main/image.png)

Описание схемы:
- Пользователь → Оркестратор: Отправляет POST-запрос на /api/v1/calculate с выражением, например {"expression": "2+2*2"}.
- Оркестратор: Парсит выражение и генерирует задачи для выполнения.
- Оркестратор → Пользователь: Возвращает уникальный идентификатор выражения, например {"id": "expr-id"}.
- Цикл (loop):
- Агент → Оркестратор: Запрашивает задачу через GET /internal/task.
- Оркестратор → Агент: Возвращает задачу (например, часть выражения для вычисления).
- Агент: Выполняет задачу (например, считает 2*2=4).
- Агент → Оркестратор: Отправляет результат через POST /internal/task/result, например {"id": "task-id", "result": 4}.
- Оркестратор: Обновляет статус задачи на "completed".
- Пользователь → Оркестратор: Запрашивает статус выражения через GET /api/v1/expressions/{id}.
- Оркестратор → Пользователь: Возвращает данные выражения, включая статус и итоговый результат, например {"expression": { "status": "completed", "result": 6, ... }}.
## Структура проекта

- `cmd/` - директория с файлами `orchestrator/main.go` и `agent/main.go` для запуска оркестратора и агента.
- `internal/orchestrator/application/` - код оркестратора (сервер), который принимает запросы, распределяет задачи и возвращает результаты.
- `internal/orchestrator/models/` - структуры данных для выражений и задач.
- `internal/agent/worker/` - код агента, выполняющего вычисления задач.
- `pkg/calculation/` - логика перевода выражений в обратную польскую запись, парсинга выражений и преобразования их в задачи.
- `pkg/config/` - конфигурация сервиса.
- `.env` - файл с переменными среды(время операций и вычислительная мощность).

## Запуск

### Общие шаги
1. Установите Golang: [https://go.dev/dl/](https://go.dev/dl/).
2. Установите Git: [https://git-scm.com/downloads](https://git-scm.com/downloads).
3. Склонируйте проект с GitHub:
```
git clone https://github.com/zalhui/calc_golang
```
4. Перейдите в директорию проекта:
```
cd calc_golang
```
### Сценарий 1: Запуск на Unix-системах (Linux, macOS) с помощью Makefile
1. Убедитесь, что `make` установлен (обычно предустановлен):
- Если нет, установите:
  - Linux: `sudo apt install make` (Ubuntu/Debian) или `sudo yum install make` (CentOS).
  - macOS: `xcode-select --install`.
2. Запустите проект одной командой:
```
make
```
Это запустит оркестратор и агента в фоновом режиме. Логи будут выводиться в консоль.
3. Для остановки процессов:
```
make clean
```

Сервер будет доступен по адресу `http://localhost:8080`.
### Сценарий 2: Запуск на Windows с помощью двух терминалов
1. Откройте два терминала (например, Git Bash, CMD или PowerShell).
2. В первом терминале запустите оркестратор:
```
go run ./cmd/orchestrator/main.go
```
3. Во втором терминале запустите агента:
```
go run ./cmd/agent/main.go
```
4. Для остановки нажмите `Ctrl+C` в каждом терминале.

Сервер будет доступен по адресу `http://localhost:8080`.
## Работа с сервисом

Для взаимодействия с сервисом используйте командную строку (Git Bash на Windows) или инструменты вроде Postman.

### Основные эндпоинты

1. **Отправка выражения на вычисление**  
URL: `http://localhost:8080/api/v1/calculate`  
Метод: `POST`  
Тело запроса:
```
{
"expression": "арифметическое выражение"
}
```
Ответ: ID выражения для последующего отслеживания.

2. **Получение статуса и результата выражения**  
URL: `http://localhost:8080/api/v1/expressions/{id}`  
Метод: `GET`  
Ответ: полная информация о выражении, включая статус, результат (если вычислено), а также инормацию о всех подвыражениях, от которых оно зависит.

3. **Получение списка всех выражений**  
URL: `http://localhost:8080/api/v1/expressions`  
Метод: `GET`  
Ответ: список всех выражений с их статусами, результатами и зависимостями.

## Примеры работы с сервисом

*Примеры приведены для командной строки Git Bash.*

### 1. Корректный запрос на вычисление
Запрос:

```
url -X POST 'http://localhost:8080/api/v1/calculate' 

--header 'Content-Type: application/json' 

--data '{
"expression": "2+2*2"
}'
```
Ответ:
```
{"id": "de9b328c-52a7-4454-b41f-9d7bef6ff24e"}
```
Код: `[201]`

### 2. Получение результата выражения
Запрос (через несколько секунд, чтобы вычисления завершились):
```
curl 'http://localhost:8080/api/v1/expressions/de9b328c-52a7-4454-b41f-9d7bef6ff24e'
```
*Результат выражения лежит в поле "result":*

Ответ:
```
{
"expression": {
"id": "de9b328c-52a7-4454-b41f-9d7bef6ff24e",
"status": "completed",
"result": 6,
"tasks": [
{
"id": "c154a023-b86c-4ae5-8a49-2cd2c3f89616",
"expression_id": "de9b328c-52a7-4454-b41f-9d7bef6ff24e",
"arg1": "2",
"arg2": "2",
"operation": "*",
"operation_time": 1000000000,
"status": "completed",
"result": 4,
"dependencies": null
},
{
"id": "c03a4806-336a-4d80-82d1-12069b5389c5",
"expression_id": "de9b328c-52a7-4454-b41f-9d7bef6ff24e",
"arg1": "task_c154a023-b86c-4ae5-8a49-2cd2c3f89616_result",
"arg2": "2",
"operation": "+",
"operation_time": 1000000000,
"status": "completed",
"result": 6,
"dependencies": ["c154a023-b86c-4ae5-8a49-2cd2c3f89616"]
}
]
}
}
```

Код: `[200]`

### 3. Получение списка всех выражений
Запрос:
```
curl 'http://localhost:8080/api/v1/expressions'
```

```
Ответ (пример с одним выражением):
{
"expressions": [
{
"id": "de9b328c-52a7-4454-b41f-9d7bef6ff24e",
"status": "completed",
"result": 6,
"tasks": [
// ... (аналогично предыдущему примеру)
]
}
]
}
```

Код: `[200]`

### 4. Запрос с неправильным методом (не POST)
Запрос:
```
curl -X GET 'http://localhost:8080/api/v1/calculate' 

--header 'Content-Type: application/json' 

--data '{
"expression": "2+2"
}'
```
Ответ:
```
only POST method allowed
```
Код: `[405]`
### 5. Запрос с некорректным телом
Запрос:
```
curl -X POST 'http://localhost:8080/api/v1/calculate' 

--header 'Content-Type: application/json' 

--data '{
"expression": "2+2
}'
```
Ответ:
```
invalid character '\n' in string literal
```
Код: `[400]`

### 6. Запрос с делением на ноль
Запрос:
```
curl -X POST 'http://localhost:8080/api/v1/calculate' 

--header 'Content-Type: application/json' 

--data '{
"expression": "2/0"
}'
```
Ответ:
```
expression is not valid. division by zero
```
Код: `[422]`

### 7. Запрос с несовпадающими скобками
Запрос:
```
curl -X POST 'http://localhost:8080/api/v1/calculate' 

--header 'Content-Type: application/json' 

--data '{
"expression": "2+(3+4"
}'
```
Ответ:
```
expression is not valid. number of brackets doesn't match
```

Код: `[422]`

### 8. Запрос с недопустимыми символами
Запрос:
```
curl -X POST 'http://localhost:8080/api/v1/calculate' 

--header 'Content-Type: application/json' 

--data '{
"expression": "2+x"
}'
```
Ответ:
```
expression is not valid. only numbers and ( ) + - * / allowed
```
Код: `[422]`

### 9. Запрос с недостаточным количеством значений
Запрос:
```
curl -X POST 'http://localhost:8080/api/v1/calculate' 

--header 'Content-Type: application/json' 

--data '{
"expression": "2++2"
}'
```
Ответ:
```
expression is not valid. not enough values
```
Код: `[422]`

### 10. Запрос выражения по несуществующему ID
Запрос:
```
curl 'http://localhost:8080/api/v1/expressions/12345'
```
Ответ:
```
expression not found
```
Код: `[404]`
**В случае иной ошибки на стороне сервера будет получен ответ:**
```
{"error":"Internal server error"}
```
с кодом `[500]`.
## Замечания
- Время выполнения операций (сложение, вычитание, умножение, деление) задается в `.env` и по умолчанию составляет 1 секунду на операцию. Вы можете изменять эти значения для более наглядной демонстрации функций сервиса.
- Статус выражения может быть `"pending"` (в процессе), `"completed"` (завершено) или `"error"` (ошибка).
- Для полного завершения вычисления сложных выражений может потребоваться несколько секунд в зависимости от количества задач и настроек `.env`.
